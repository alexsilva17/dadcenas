!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("sift")):"function"==typeof define&&define.amd?define(["exports","sift"],t):t((e=e||self).casl={},e.sift)}(this,function(e,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){void 0===t&&(t={}),Error.call(this),this.constructor=u,this.subject=t.subject,this.subjectName=t.subjectName,this.action=t.action,this.field=t.field,this.message=e||'Cannot execute "'+this.action+'" on "'+this.subjectName+'"',"function"==typeof Error.captureStackTrace?(this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor)):this.stack=new Error(this.message).stack}function p(e){return Array.isArray(e)?e:[e]}function o(e){if(!e||"string"==typeof e)return e;var t="object"==typeof e?e.constructor:e;return t.modelName||t.name}n=n&&n.hasOwnProperty("default")?n.default:n,u.prototype=Object.create(Error.prototype);var i=/[-/\\^$+?.()|[\]{}]/g,s=/\.?\*+\.?/g,a=/\*+/,c=/\./g;function l(e,t,n){var r="*"===n[0]||"."===e[0]&&"."===e[e.length-1]?"+":"*",i=-1===e.indexOf("**")?"[^.]":".",s=e.replace(c,"\\$&").replace(a,i+r);return t+e.length===n.length?"(?:"+s+")?":s}function f(e,t,n){return"."!==e||"*"!==n[t-1]&&"*"!==n[t+1]?"\\"+e:e}var h=function(){function e(e){this.actions=e.actions||e.action,this.subject=e.subject,this.fields=e.fields&&0!==e.fields.length?p(e.fields):void 0,Object.defineProperty(this,"_fieldsPattern",{writable:!0}),this.inverted=!!e.inverted,this.conditions=e.conditions,Object.defineProperty(this,"_matches",{writable:!0,value:this.conditions?n(this.conditions):void 0}),this.reason=e.reason}var t=e.prototype;return t.matches=function(e){return!this._matches||("string"==typeof e?!this.inverted:this._matches(e))},t.isRelevantFor=function(e,t){return!this.fields||(t?this.matchesField(t):!this.inverted)},t.matchesField=function(e){return void 0===this._fieldsPattern&&(this._fieldsPattern=-1===this.fields.join("").indexOf("*")?null:function(e){var t=e.map(function(e){return e.replace(i,f).replace(s,l)}),n=1<t.length?"(?:"+t.join("|")+")":t[0];return new RegExp("^"+n+"$")}(this.fields)),null===this._fieldsPattern||-1!==e.indexOf("*")?-1!==this.fields.indexOf(e):this._fieldsPattern.test(e)},e}(),v="undefined"!=typeof Symbol?Symbol("private"):"__"+Date.now(),d={crud:["create","read","update","delete"]};function b(e,t){return e===t||Array.isArray(t)&&-1!==t.indexOf(e)}var y=function(){function e(e,t){var n=void 0===t?{}:t,r=n.RuleType,i=void 0===r?h:r,s=n.subjectName,a=void 0===s?o:s;this[v]={RuleType:i,subjectName:a,originalRules:e||[],hasPerFieldRules:!1,indexedRules:Object.create(null),mergedRules:Object.create(null),events:{},aliases:function(e){return JSON.parse(JSON.stringify(e))}(d)},this.update(e)}e.addAlias=function(e,t){if("manage"===e||b("manage",t))throw new Error('Cannot add alias for "manage" action because it represents any action');if(b(e,t))throw new Error("Attempt to alias action to itself: "+e+" -> "+t.toString());return d[e]=t,this};var t=e.prototype;return t.update=function(e){if(!Array.isArray(e))return this;var t={rules:e,ability:this};this.emit("update",t),this[v].originalRules=e.slice(0),this[v].mergedRules=Object.create(null);var n=this.buildIndexFor(e);return"production"!==process.env.NODE_ENV&&n.isAllInverted&&e.length&&console.warn("[casl]: Ability contains only inverted rules. That means user will not be able to do any actions. This will be changed to Error throw in the next major version"),this[v].indexedRules=n.rules,this[v].hasPerFieldRules=n.hasPerFieldRules,this.emit("updated",t),this},t.buildIndexFor=function(e){for(var t=Object.create(null),n=this[v].RuleType,r=!0,i=!1,s=0;s<e.length;s++){var a=new n(e[s]),o=this.expandActions(a.actions),u=p(a.subject),c=e.length-s-1;r=!(!r||!a.inverted),!i&&a.fields&&(i=!0);for(var l=0;l<u.length;l++){var f=u[l];t[f]=t[f]||Object.create(null);for(var h=0;h<o.length;h++){var d=o[h];t[f][d]=t[f][d]||Object.create(null),t[f][d][c]=a}}}return{isAllInverted:r,hasPerFieldRules:i,rules:t}},t.expandActions=function(e){for(var t=this[v].aliases,n=p(e),r=0;r<n.length;){var i=n[r++];t.hasOwnProperty(i)&&(n=n.concat(t[i]))}return n},t.can=function(e,t,n){if(n&&"string"!=typeof n)throw new Error("Ability.can expects 3rd parameter to be a string. See https://stalniy.github.io/casl/abilities/2017/07/21/check-abilities.html#checking-fields for details");var r=this.relevantRuleFor(e,t,n);return!!r&&!r.inverted},t.relevantRuleFor=function(e,t,n){for(var r=this.rulesFor(e,t,n),i=0;i<r.length;i++)if(r[i].matches(t))return r[i];return null},t.possibleRulesFor=function(e,t){var n=this[v].subjectName(t),r=this[v].mergedRules,i=n+"_"+e;return r[i]||(r[i]=this.mergeRulesFor(e,n)),r[i]},t.mergeRulesFor=function(r,e){var i=this[v].indexedRules;return[e,"all"].reduce(function(e,t){var n=i[t];return n?Object.assign(e,n[r],n.manage):e},[]).filter(Boolean)},t.rulesFor=function(e,t,n){var r=this.possibleRulesFor(e,t);return this[v].hasPerFieldRules?r.filter(function(e){return e.isRelevantFor(t,n)}):r},t.cannot=function(){return!this.can.apply(this,arguments)},t.throwUnlessCan=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=this.relevantRuleFor.apply(this,t);if(!r||r.inverted){var i=t[0],s=t[1],a=t[2],o=this[v].subjectName(s);throw new u(r?r.reason:null,{action:i,subjectName:o,subject:s,field:a})}},t.on=function(t,n){var r=this[v].events,i=!0;return r[t]||(r[t]=[]),r[t].push(n),function(){if(i){var e=r[t].indexOf(n);r[t].splice(e,1),i=!1}}},t.emit=function(e,t){var n=this[v].events[e];n&&n.slice(0).forEach(function(e){return e(t)})},function(e,t,n){t&&r(e.prototype,t),n&&r(e,n)}(e,[{key:"rules",get:function(){return this[v].originalRules}}]),e}();function m(e){return![].concat(e).some(function(e){return"string"!=typeof e})}function g(e){return e&&"object"==typeof e}var j=function(){function e(e){this.rule=e}return e.prototype.because=function(e){return this.rule.reason=e,this},e}(),t=function(){function e(e){var t=(void 0===e?{}:e).subjectName,n=void 0===t?o:t;this.rules=[],this.subjectName=n}e.define=function(e,t){function n(){return new y(s.rules,r)}var r="function"==typeof e?{}:e,i=e===r?t:e,s=new this(r),a=i(s.can.bind(s),s.cannot.bind(s));return a&&"function"==typeof a.then?a.then(n):n()},e.extract=function(){var e=new this;return{can:e.can.bind(e),cannot:e.cannot.bind(e),rules:e.rules}};var t=e.prototype;return t.can=function(e,t,n,r){if(!m(e))throw new TypeError("AbilityBuilder#can expects the first parameter to be an action or array of actions");var i=[].concat(t).map(this.subjectName);if(!m(i))throw new TypeError("AbilityBuilder#can expects the second argument to be a subject name/type or an array of subject names/types");var s={actions:e,subject:i};return!Array.isArray(n)&&"string"!=typeof n||(s.fields=n),(g(r)||!s.fields&&g(n))&&(s.conditions=r||n),this.rules.push(s),new j(s)},t.cannot=function(){var e=this.can.apply(this,arguments);return e.rule.inverted=!0,e},e}();e.Ability=y,e.AbilityBuilder=t,e.ForbiddenError=u,e.Rule=h,e.RuleBuilder=j,Object.defineProperty(e,"__esModule",{value:!0})});
